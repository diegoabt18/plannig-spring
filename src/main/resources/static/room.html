<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Planning Poker - Sala</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
          font-family: "Segoe UI", Arial, sans-serif;
          background: linear-gradient(135deg, #74ebd5, #acb6e5);
          margin: 0;
          padding: 0;
          color: #2c3e50;
          display: flex;
          justify-content: center;
          align-items: flex-start;
          min-height: 100vh;
        }

        .container {
          background: #fff;
          padding: 2rem;
          margin: 2rem;
          border-radius: 1rem;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
          width: 100%;
          max-width: 800px;
          animation: fadeIn 0.6s ease-in-out;
        }

        h1 {
          text-align: center;
          margin-bottom: 0.5rem;
          color: #34495e;
        }

        h2, h3 {
          text-align: center;
          color: #555;
        }

        #welcome {
          margin-bottom: 1.5rem;
          font-weight: normal;
          text-align: center;
        }

        .cards, .actions {
          display: flex;
          justify-content: center;
          flex-wrap: wrap;
          gap: 1rem;
          margin: 1.5rem 0;
        }

        button {
          padding: 0.8rem 1.2rem;
          font-size: 1rem;
          border: none;
          border-radius: 0.6rem;
          cursor: pointer;
          transition: all 0.2s ease-in-out;
        }

        .vote-btn {
          background: #4facfe;
          color: #fff;
          font-weight: bold;
          width: 70px;
          height: 70px;
          border-radius: 50%;
          font-size: 1.2rem;
        }

        .vote-btn:hover {
          background: #00c6ff;
          transform: scale(1.1);
        }

        .action-btn {
          background: #2ecc71;
          color: white;
        }

        .action-btn:hover {
          background: #27ae60;
          transform: scale(1.05);
        }

        .share-btn {
          background: #f39c12;
          color: white;
        }

        .share-btn:hover {
          background: #e67e22;
          transform: scale(1.05);
        }

        .card {
          background: #f9f9f9;
          padding: 1rem;
          margin-top: 1rem;
          border-radius: 0.8rem;
          box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .list {
          display: flex;
          flex-direction: column;
          gap: 0.4rem;
          font-size: 1rem;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Planning Poker</h1>
    <h2 id="roomTitle"></h2>
    <h3 id="welcome"></h3>

    <!-- Botones de votaci√≥n -->
    <div class="cards">
        <button class="vote-btn" onclick="vote('1')">1</button>
        <button class="vote-btn" onclick="vote('2')">2</button>
        <button class="vote-btn" onclick="vote('3')">3</button>
        <button class="vote-btn" onclick="vote('5')">5</button>
        <button class="vote-btn" onclick="vote('8')">8</button>
        <button class="vote-btn" onclick="vote('13')">13</button>
        <button class="vote-btn" onclick="vote('?')">?</button>
    </div>

    <!-- Acciones de la sala -->
    <div class="actions">
        <button class="action-btn" onclick="reveal()">Revelar</button>
        <button class="action-btn" onclick="reset()">Reset</button>
        <button class="share-btn" onclick="shareRoom()">Compartir Link</button>
    </div>

    <!-- Participantes -->
    <div class="card">
        <h3>Participantes</h3>
        <div id="players" class="list"></div>
    </div>

    <!-- Votos -->
    <div class="card">
        <h3>Votos</h3>
        <div id="votesList" class="list"></div>
    </div>
</div>

<script>
    const username = sessionStorage.getItem("username");
    if (!username) {
      window.location.href = window.location.pathname.replace("/play", "");
    }
    document.getElementById("welcome").innerText = "Bienvenido, " + username;

    let stompClient = null;
    const roomId = window.location.pathname.split("/")[2];
    document.getElementById("roomTitle").innerText = "Sala: " + roomId;

    function connect() {
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);
      stompClient.connect({}, () => {
        stompClient.subscribe("/topic/room/" + roomId, (msg) => {
          const room = JSON.parse(msg.body);
          renderRoom(room);
        });
        stompClient.send("/app/join", {}, JSON.stringify({ roomId, username }));
      });
    }

    function vote(value) {
      stompClient.send("/app/vote", {}, JSON.stringify({ roomId, user: username, value }));
    }

    function reveal() {
      stompClient.send("/app/reveal", {}, JSON.stringify({ roomId, user: username }));
    }

    function reset() {
      stompClient.send("/app/reset", {}, JSON.stringify({ roomId, user: username }));
    }

    function shareRoom() {
      const url = window.location.origin + "/room/" + roomId;
      navigator.clipboard.writeText(url).then(() => {
        alert("Link copiado: " + url);
      });
    }

    function renderRoom(room) {
      const playersDiv = document.getElementById("players");
      playersDiv.innerHTML = "";
      (room.players || []).forEach(p => {
        playersDiv.innerHTML += `<div>üë§ ${p}</div>`;
      });

      const votesList = document.getElementById("votesList");
      votesList.innerHTML = "";
      for (const [user, val] of Object.entries(room.votes || {})) {
        const display = room.revealed ? val : "‚ùì";
        votesList.innerHTML += `<div>üÉè ${user}: <strong>${display}</strong></div>`;
      }
    }

    connect();
</script>
</body>
</html>
